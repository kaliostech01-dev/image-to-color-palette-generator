<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Image → Color Palette — Extract clean palettes from any image</title>
  <meta name="description" content="Upload an image and extract a clean color palette. Pure HTML, CSS and JS — no libraries. Download JSON or copy CSS variables." />
  <meta name="theme-color" content="#071427" />

  <!-- Open Graph / Social cards -->
  <meta property="og:title" content="Image → Color Palette" />
  <meta property="og:description" content="Extract color palettes from images. Click swatches to copy hex, download JSON or copy CSS vars." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='630'%3E%3Crect width='100%25' height='100%25' fill='%23071227'/%3E%3Ctext x='50%25' y='50%25' fill='%23e6eef6' font-size='48' font-family='Inter, system-ui, -apple-system, Roboto, Arial' dominant-baseline='middle' text-anchor='middle'%3EImage → Palette%3C/text%3E%3C/svg%3E" />

  <!-- Simple favicon (inline) -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%237dd3fc'/%3E%3Ccircle cx='32' cy='28' r='16' fill='%23071227'/%3E%3C/svg%3E">

  <!-- Google font (optional) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#071427;
      --panel:#0f1724;
      --muted:#9aa5b1;
      --accent:#7dd3fc;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
      --success:#06b6d4;
      color-scheme: dark;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:linear-gradient(180deg,#041022 0%, var(--bg) 100%);
      color:#e6eef6;
      padding:28px;
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.35;
    }

    .container{
      width:100%;
      max-width:1080px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
      border-radius:var(--radius);
      padding:20px;
      box-shadow: 0 10px 40px rgba(2,6,23,0.6);
      display:grid;
      gap:18px;
      grid-template-columns: 1fr 380px;
      align-items:start;
    }

    header{
      grid-column:1/-1;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    header h1{margin:0;font-size:18px}
    header p{margin:0;color:var(--muted);font-size:13px}

    .left{padding:8px}
    .uploader{
      border:2px dashed rgba(255,255,255,0.05);
      padding:18px;
      border-radius:10px;
      display:flex;
      gap:12px;
      align-items:center;
      background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    }

    .dropzone{
      flex:1;
      min-height:140px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:8px;
      text-align:center;
      color:var(--muted);
      cursor:pointer;
      border-radius:8px;
      outline: none;
    }
    .dropzone:focus{box-shadow:0 0 0 4px rgba(125,211,252,0.08)}

    .controls{margin-top:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .controls label{color:var(--muted);font-size:13px}
    input[type=range]{width:160px}

    button{
      background:linear-gradient(180deg,var(--accent),#38bdf8);
      border:none;
      color:#04202a;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);}

    .preview{margin-top:12px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);background:#071022;display:flex;gap:12px;padding:12px;align-items:center}
    .preview img{max-width:220px;max-height:180px;object-fit:cover;border-radius:6px;box-shadow:0 6px 20px rgba(0,0,0,0.6)}
    .meta{color:var(--muted);font-size:13px}

    .right{padding:12px;border-left:1px solid rgba(255,255,255,0.02)}
    .palette{display:grid;grid-template-columns:repeat(1,1fr);gap:10px;margin-top:12px}

    /* swatch improved layout */
    .swatch{
      height:72px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;padding:12px;color:rgba(0,0,0,0.8);font-weight:700;cursor:pointer;user-select:none;transition:transform .12s ease, box-shadow .12s ease;
    }
    .swatch:active{transform:scale(.997)}
    .swatch .label{font-size:13px;color:rgba(0,0,0,0.65);}
    .swatch small{background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:10px;font-weight:700;font-size:12px;color:#041214}

    .actions{display:flex;gap:8px;margin-top:12px}
    .note{color:var(--muted);font-size:12px;margin-top:8px}

    /* utility */
    .status{color:var(--muted);font-size:13px}
    .kbd{background:rgba(255,255,255,0.04);padding:6px 8px;border-radius:6px;font-weight:700}

    /* responsive */
    @media (max-width:920px){
      .container{grid-template-columns:1fr; padding:12px}
      .right{border-left:none;border-top:1px solid rgba(255,255,255,0.02)}
    }
  </style>
</head>
<body>
  <div class="container" role="application" aria-label="Image to color palette app">
    <header>
      <div>
        <h1>Image → Color Palette</h1>
        <p>Upload an image, pick how many colors, and extract a clean palette. Click a swatch to copy hex.</p>
      </div>
      <div style="text-align:right">
        <small style="color:var(--muted)">Single-file • No libraries • Accessible</small>
      </div>
    </header>

    <section class="left" aria-label="uploader and preview">
      <div class="uploader">
        <div id="dropzone" class="dropzone" tabindex="0" role="button" aria-label="Drop image or click to upload">
          <svg width="42" height="42" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 15v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M16 8 12 3 8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <div style="font-weight:800">Drop image here or click to upload</div>
          <div style="font-size:13px;color:var(--muted)">PNG, JPG, GIF — up to 10MB</div>
          <input id="file" accept="image/*" type="file" style="display:none" aria-hidden="true" />
        </div>
      </div>

      <div class="controls" role="region" aria-label="controls">
        <label for="count">Colors:</label>
        <input id="count" type="range" min="2" max="12" value="6" aria-label="Number of colors" />
        <span id="countVal" class="kbd">6</span>
        <button id="extract" title="Extract palette (E)">Extract</button>
        <button id="clear" class="btn-ghost" title="Clear (C)">Clear</button>

        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <div class="status" id="status">Ready.</div>
        </div>
      </div>

      <div class="preview" aria-live="polite">
        <img id="previewImg" alt="Image preview" src="" style="display:none" />
        <div class="meta">
          <div id="info">No image loaded</div>
          <div class="note">Tip: use large, high-quality images for better results. The algorithm samples pixels and groups similar colors.</div>
        </div>
      </div>
    </section>

    <aside class="right" aria-label="palette">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>Palette</strong>
          <div style="color:var(--muted);font-size:13px">Click a swatch to copy hex, right-click to copy RGB.</div>
        </div>
        <div style="text-align:right">
          <small id="paletteCount" style="color:var(--muted)">0 swatches</small>
        </div>
      </div>

      <div class="palette" id="palette" aria-live="polite"></div>

      <div class="actions">
        <button id="copyCss" class="btn-ghost">Copy CSS vars</button>
        <button id="downloadJson" class="btn-ghost">Download JSON</button>
        <button id="downloadSvg" class="btn-ghost">Download SVG</button>
      </div>

      <div class="note" id="extraNote">Status: ready.</div>
    </aside>
  </div>

  <canvas id="work" style="display:none"></canvas>

  <noscript>
    <div style="position:fixed;left:12px;right:12px;bottom:12px;background:#071022;padding:12px;border-radius:10px;color:var(--muted);text-align:center">This app requires JavaScript to extract palettes. Please enable JavaScript.</div>
  </noscript>

<script>
/* Improved single-file JS
 - better UX: loading indicator, tooltips, keyboard shortcuts
 - export SVG + improved copy feedback
 - accessible focus styles and ARIA updates
*/

const fileInput = document.getElementById('file');
const dropzone = document.getElementById('dropzone');
const previewImg = document.getElementById('previewImg');
const canvas = document.getElementById('work');
const ctx = canvas.getContext('2d', { willReadFrequently: true });
const countRange = document.getElementById('count');
const countVal = document.getElementById('countVal');
const extractBtn = document.getElementById('extract');
const paletteEl = document.getElementById('palette');
const status = document.getElementById('status');
const paletteCount = document.getElementById('paletteCount');
const clearBtn = document.getElementById('clear');
const copyCssBtn = document.getElementById('copyCss');
const downloadJsonBtn = document.getElementById('downloadJson');
const downloadSvgBtn = document.getElementById('downloadSvg');
const info = document.getElementById('info');
const extraNote = document.getElementById('extraNote');

let loadedImage = null;
let lastPalette = [];

countRange.addEventListener('input', () => countVal.textContent = countRange.value);

// accessibility: enter/space opens file picker
dropzone.addEventListener('click', () => fileInput.click());
dropzone.addEventListener('keydown', (e) => { if(e.key==='Enter' || e.key===' ') fileInput.click(); });

fileInput.addEventListener('change', (e) => { if(e.target.files && e.target.files[0]) loadFile(e.target.files[0]); });

['dragenter','dragover'].forEach(evt =>
  dropzone.addEventListener(evt, (e) => { e.preventDefault(); dropzone.style.opacity=0.95; }
));
['dragleave','drop','dragend'].forEach(evt =>
  dropzone.addEventListener(evt, (e) => { e.preventDefault(); dropzone.style.opacity=1; }
));

dropzone.addEventListener('drop', (e) => {
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if(f) loadFile(f);
});

clearBtn.addEventListener('click', clearAll);
extractBtn.addEventListener('click', () => startExtract());

copyCssBtn.addEventListener('click', () => {
  if(!lastPalette.length){ setStatus('No palette to copy.'); return; }
  const css = paletteToCssVars(lastPalette);
  navigator.clipboard.writeText(css).then(()=> setStatus('CSS variables copied to clipboard.'))
    .catch(()=> setStatus('Copy failed.'));
});

downloadJsonBtn.addEventListener('click', () => {
  if(!lastPalette.length){ setStatus('No palette to download.'); return; }
  const data = JSON.stringify(lastPalette, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  triggerDownload(blob, 'palette.json');
  setStatus('Palette JSON downloaded.');
});

// SVG export (simple visual palette)
downloadSvgBtn.addEventListener('click', () => {
  if(!lastPalette.length){ setStatus('No palette to download.'); return; }
  const svg = paletteToSvg(lastPalette);
  const blob = new Blob([svg], {type:'image/svg+xml'});
  triggerDownload(blob, 'palette.svg');
  setStatus('SVG downloaded.');
});

function triggerDownload(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
}

function setStatus(msg){
  status.textContent = msg; extraNote.textContent = msg; // mirrored
}

function loadFile(file){
  if(!file.type.startsWith('image/')){ setStatus('Not an image file.'); return; }
  if(file.size > 12 * 1024 * 1024){ setStatus('File too large (>12MB).'); return; }

  const url = URL.createObjectURL(file);
  const img = new Image();
  img.onload = () => {
    loadedImage = img;
    previewImg.src = url; previewImg.style.display='block';
    info.textContent = `${img.width} × ${img.height} — ${Math.round(file.size/1024)} KB`;
    setStatus('Image loaded. Click Extract.');
    URL.revokeObjectURL(url);
  };
  img.onerror = () => { setStatus('Could not load image.'); URL.revokeObjectURL(url); };
  img.src = url;
}

function clearAll(){
  loadedImage = null; previewImg.src = ''; previewImg.style.display = 'none';
  paletteEl.innerHTML = ''; lastPalette = [];
  info.textContent = 'No image loaded'; setStatus('Cleared.'); paletteCount.textContent = '0 swatches';
}

function startExtract(){
  if(!loadedImage){ setStatus('Load an image first.'); return; }
  setStatus('Extracting colors...');
  // small delay so browser can paint status
  setTimeout(()=>{
    try{
      const palette = extractPalette(loadedImage, parseInt(countRange.value,10));
      lastPalette = palette; renderPalette(palette); setStatus('Done.');
    }catch(e){ console.error(e); setStatus('Extraction failed.'); }
  }, 10);
}

/* quantizer (same approach with small improvements) */
function extractPalette(img, count){
  const maxSide = 900;
  let w = img.width, h = img.height;
  if(Math.max(w,h) > maxSide){ const ratio = maxSide / Math.max(w,h); w = Math.round(w * ratio); h = Math.round(h * ratio); }
  canvas.width = w; canvas.height = h; ctx.clearRect(0,0,w,h); ctx.drawImage(img,0,0,w,h);

  const step = Math.max(1, Math.floor(Math.max(w,h) / 300));
  const imgData = ctx.getImageData(0,0,w,h).data;

  const shift = count <= 4 ? 3 : count <= 8 ? 2 : 1;
  const buckets = new Map();
  for(let y=0;y<h;y+=step){
    for(let x=0;x<w;x+=step){
      const idx = (y * w + x) * 4;
      const r = imgData[idx], g = imgData[idx+1], b = imgData[idx+2], a = imgData[idx+3];
      if(a < 125) continue;
      const key = ((r >> shift) << 16) | ((g >> shift) << 8) | (b >> shift);
      const ex = buckets.get(key);
      if(ex){ ex.count++; ex.rsum+=r; ex.gsum+=g; ex.bsum+=b; } else { buckets.set(key, {count:1, rsum:r, gsum:g, bsum:b}); }
    }
  }

  const arr = [];
  buckets.forEach((v)=>{ const avgR=Math.round(v.rsum/v.count), avgG=Math.round(v.gsum/v.count), avgB=Math.round(v.bsum/v.count); arr.push({count:v.count, r:avgR, g:avgG, b:avgB}); });
  arr.sort((a,b)=> b.count - a.count);

  const selected = []; const used = [];
  for(const item of arr){ if(selected.length>=count) break; const hex = rgbToHex(item.r,item.g,item.b);
    let ok=true; for(const s of used){ const d=colorDistance([s.r,s.g,s.b],[item.r,item.g,item.b]); if(d<28){ ok=false; break; } }
    if(ok){ selected.push({hex, r:item.r, g:item.g, b:item.b, count:item.count}); used.push(item); }
    else{ if(arr.indexOf(item) > arr.length - 40 && selected.length < count){ selected.push({hex, r:item.r, g:item.g, b:item.b, count:item.count}); used.push(item); } }
  }
  if(selected.length < count){ for(const item of arr){ const hex = rgbToHex(item.r,item.g,item.b); if(!selected.find(s=>s.hex===hex)){ selected.push({hex, r:item.r, g:item.g, b:item.b, count:item.count}); if(selected.length>=count) break; } } }
  return selected.slice(0,count);
}

function colorDistance(a,b){ const dr=a[0]-b[0], dg=a[1]-b[1], db=a[2]-b[2]; return Math.sqrt(dr*dr+dg*dg+db*db); }
function rgbToHex(r,g,b){ return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('').toUpperCase(); }

function renderPalette(palette){
  paletteEl.innerHTML=''; paletteCount.textContent = `${palette.length} swatches`;
  palette.forEach((p,i)=>{
    const sw = document.createElement('button');
    sw.className='swatch';
    sw.setAttribute('aria-label', `Copy ${p.hex}`);
    sw.style.background = p.hex;
    const lum = (0.299*p.r + 0.587*p.g + 0.114*p.b);
    sw.style.color = lum > 160 ? 'rgba(0,0,0,0.85)' : '#fff';

    const label = document.createElement('div');
    label.innerHTML = `<div style="font-size:13px">${p.hex}</div><small>#${(i+1).toString().padStart(2,'0')}</small>`;
    sw.appendChild(label);

    sw.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(p.hex); setStatus(`${p.hex} copied to clipboard.`); }
      catch(e){ setStatus('Copy failed.'); }
    });

    sw.addEventListener('contextmenu', (e)=>{ e.preventDefault(); const rgb = `rgb(${p.r}, ${p.g}, ${p.b})`; navigator.clipboard.writeText(rgb).then(()=> setStatus(`${rgb} copied.`)); });

    paletteEl.appendChild(sw);
  });
}

function paletteToCssVars(palette){ let lines=':root {'; palette.forEach((p,i)=>{ lines += `\n  --c-${i+1}: ${p.hex};`; }); lines += '\n}\n'; return lines; }

function paletteToSvg(palette){ const w=600, h=80; const sw=w/palette.length; let rects=''; palette.forEach((p,i)=>{ rects += `<rect x="${i*sw}" y="0" width="${sw}" height="${h}" fill="${p.hex}"/>`; }); const labels = palette.map((p,i)=>`<text x="${i*sw + sw/2}" y="${h/1.9}" font-family="Inter, system-ui, Arial" font-size="18" fill="${getReadable(p)}" text-anchor="middle">${p.hex}</text>`).join(''); return `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">${rects}${labels}</svg>`; }

function getReadable(p){ const lum=(0.299*p.r+0.587*p.g+0.114*p.b); return lum>160? '#000' : '#fff'; }

// keyboard shortcuts
document.addEventListener('keydown',(e)=>{ if(e.key==='e' || e.key==='E') extractBtn.click(); if(e.key==='c' || e.key==='C') clearBtn.click(); });

// expose for debugging
window._extractPalette = extractPalette;

// small polish: pre-select a sample image (optional) — commented out
// fetch('demo.jpg').then(...)
</script>
</body>
</html>
